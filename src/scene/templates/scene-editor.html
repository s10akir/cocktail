{% load static %}

<html>
    <head>
        <script type="text/javascript" src="{% static 'javascripts/jquery-3.4.1.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'javascripts/jquery-ui-1.12.1/jquery-ui.min.js' %}"></script>
        <link rel="stylesheet" type="text/css" href="{% static 'javascripts/jquery-ui-1.12.1/jquery-ui.min.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'css/custom.css' %}">
    </head>
    <body>
        <input type="hidden" id="sceneId" name="sceneId" value="{{ sceneId }}">
        <input type="hidden" id="deleteMode" name="deleteMode" value="off">

        <div id="output" class="rightBox">
            出力
        </div>
        <div id="delete" class="rightBox">
            モジュール<br>削除
        </div>

        <div id="modules">
            <div class='module' data-id='text'>
                <img src="{% static 'icons/text.png' %}" alt="テキスト" width="100%" height="100%">
            </div>
            <div class='module' data-id='clock'>
                <img src="{% static 'icons/clock.png' %}" alt="テキスト" width="100%" height="100%">
            </div>
        </div>
        <!-- <div id="frame"> -->
            <div id='scene'></div>
        <!-- </div> -->
        <!-- <input id="scaleUp" type="button" value="拡大">
        <input id="scaleDown" type="button" value="縮小">
        <input id="scaleReset" type="button" value="リセット"> -->
        <script type="module" src="{% static 'javascripts/index.js' %}"></script>
        <script>
            $(function() {
                $.ajax({
                    url: '/scene/api/read-module/',
                    type: 'GET',
                    headers: {'X-CSRFToken': '{{csrf_token}}'},
                    data: {sceneId: $('#sceneId').val()},
                    dataType: 'json'
                })
                .done((data) => {
                    let modules = data.modules;
                    if(modules.length < 1)
                        console.log('モジュールなし');
                    for(let i = 0; i < modules.length; i++){
                        console.log(modules[i]);
                        let frame = $('<div></div', {
                            id: i + 1000,
                            class: 'use-module',
                            css: {
                                position: 'absolute',
                                top: modules[i].top,
                                left: modules[i].left,
                                width: modules[i].width,
                                height: modules[i].height,
                            },
                        });
                        $("#scene").append(frame)
                        import('/scene/api/module/' + modules[i].moduleId)
                        .then((module) => {
                            let dom = $('#' + (i + 1000))[0]
                            module.default.initialize(dom, modules[i].data);
                        })

                        $('#' + (i + 1000))
                        .draggable({
                            handle: 'div',
                            containment: '#scene',
                            grid: [50, 50],
                        })
                        .resizable({
                            grid: [50, 50],
                        })
                        .click(function() {
                            if($('#deleteMode').val() === 'on'){
                                if(window.confirm('モジュールを削除します'))
                                    $(this).remove()
                            }
                        })
                    }
                })
                .fail((err) => {
                    console.log(err);
                })
            })
        </script>
    </body>
</html>
